# Spouští SQL migrace na Railway po deployi.
# Railway deployuje přímo z GitHubu a nemá vlastní krok pro migrace –
# tento workflow zavolá migrate API po pushu do větve, ze které Railway deployuje.
#
# Secrets (Settings → Secrets and variables → Actions):
#   RAILWAY_URL  - URL Railway aplikace (např. https://xxx.up.railway.app) – bez koncového lomítka
#   MIGRATE_KEY  - stejný klíč jako v config / Variables na Railway
#
# Uprav branch v 'on.push.branches' podle větve, ze které Railway deployuje.

name: Railway migrations

on:
  push:
    branches: [feature/rent-as-payment-requests]
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Počkat na dokončení Railway deploye
        run: sleep 90

      - name: Spustit SQL migraci na Railway
        run: |
          URL="${{ secrets.RAILWAY_URL }}/api/migrate.php?key=${{ secrets.MIGRATE_KEY }}"
          echo "Spouštím migraci: $URL"
          RESP=$(curl -s -w "\n%{http_code}" "$URL")
          BODY=$(echo "$RESP" | head -n -1)
          CODE=$(echo "$RESP" | tail -n 1)
          echo "Response ($CODE): $BODY"
          if [ "$CODE" != "200" ]; then
            echo "::error::Migrace selhala (HTTP $CODE)"
            exit 1
          fi
          echo "Migrace OK."

      - name: Spustit datovou migraci 062
        run: |
          URL="${{ secrets.RAILWAY_URL }}/api/migrate-062.php?key=${{ secrets.MIGRATE_KEY }}"
          echo "Spouštím migraci 062: $URL"
          RESP=$(curl -s -w "\n%{http_code}" "$URL")
          BODY=$(echo "$RESP" | head -n -1)
          CODE=$(echo "$RESP" | tail -n 1)
          echo "Response ($CODE): $BODY"
          if [ "$CODE" != "200" ]; then
            echo "::error::Migrace 062 selhala (HTTP $CODE)"
            exit 1
          fi
          echo "Migrace 062 OK."
